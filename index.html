<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì „êµì„ì›ì„ ê±° Â· í†µí•© ì•ˆì •íŒ</title>
  <style>
    :root{--blue:#2563eb;--blue2:#1d4ed8;--b50:#eff6ff;--g50:#f9fafb;--g100:#f3f4f6;--g200:#e5e7eb;--g600:#4b5563;--g900:#111827;--sh:0 10px 25px rgba(0,0,0,.08)}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Apple SD Gothic Neo,Noto Sans KR,Arial;color:var(--g900);background:#fff}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--g200);z-index:20}
    .nav{max-width:1080px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
    .brand{font-weight:800;display:flex;gap:10px;align-items:center}
    .logo{width:28px;height:28px;border-radius:10px;background:linear-gradient(135deg,var(--blue),var(--blue2))}
    .grow{flex:1}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;background:var(--blue);color:#fff;font-weight:700;cursor:pointer;box-shadow:var(--sh)}
    .btn:hover{background:var(--blue2)}
    .btn.secondary{background:#fff;color:var(--blue2);border:1px solid var(--g200);box-shadow:none}
    .container{max-width:1080px;margin:20px auto;padding:0 16px}
    .grid{display:grid;gap:14px}
    .card{background:#fff;border:1px solid var(--g200);border-radius:14px;box-shadow:var(--sh);padding:16px}
    section{display:none}
    section.active{display:block}
    .pill{padding:6px 10px;border-radius:999px;background:var(--b50);color:var(--blue2);font-weight:700;font-size:12px}
    .h1{font-size:24px;margin:0 0 6px}
    .h2{font-size:20px;margin:0 0 6px}
    .h3{font-size:16px;margin:0 0 6px}
    .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    input[type=text],input[type=password],input[type=number],textarea,select{padding:10px;border-radius:10px;border:1px solid var(--g200);background:var(--g50)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .list{display:flex;flex-direction:column;gap:10px}
    .position-card{border:1px dashed var(--g200);border-radius:12px;padding:12px;background:linear-gradient(180deg,#fff,#f8fbff)}
    .candidate-chip{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;background:#fff;border:1px solid var(--g200)}
    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--g200);margin-bottom:10px}
    .tab{padding:8px 12px;border-radius:10px 10px 0 0;background:var(--g100);cursor:pointer;font-weight:700}
    .tab.active{background:#fff;border:1px solid var(--g200);border-bottom-color:#fff}
    dialog{border:none;border-radius:12px;padding:16px;box-shadow:var(--sh);max-width:560px;width:92%}
    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);padding:10px 14px;border-radius:999px;background:#111827;color:#fff;box-shadow:var(--sh);z-index:99;display:none}
    .toast.show{display:block}
  </style>
  <link rel="icon" href="data:,">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: https: http:; connect-src * 'unsafe-inline' 'unsafe-eval'">
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand"><div class="logo"></div><div>ì „êµì„ì›ì„ ê±°</div></div>
      <div class="grow"></div>
      <button class="btn" data-action="open:settings">âš™ï¸ ì„¤ì •</button>
    </div>
  </header>

  <main class="container">
    <!-- ë©”ì¸ -->
    <section id="view-home" class="active">
      <div class="card" style="padding:24px;background:linear-gradient(180deg,#ffffff,#f8fbff)">
        <div class="pill">ì—°ê²° ìƒíƒœ: <b id="pillConn">ë¯¸ì„¤ì •</b></div>
        <h1 class="h1" style="font-size:28px;margin-top:8px">ì „êµì„ì›ì„ ê±°</h1>
        <p style="margin:6px 0 12px;color:var(--g600)">ê³ ìœ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê³  íˆ¬í‘œë¥¼ ì‹œì‘í•˜ì„¸ìš”.</p>
        <div class="field" style="max-width:420px">
          <label style="font-weight:700">ê³ ìœ ë²ˆí˜¸</label>
          <input id="inputVoterId" placeholder="ì˜ˆ: S0001" />
        </div>
        <div class="row" style="margin-top:6px"><button class="btn" data-action="vote:start">íˆ¬í‘œ ì‹œì‘</button></div>
        <div class="row" style="margin-top:10px;gap:10px;font-size:12px;color:var(--g600)">
          <button class="btn secondary" style="padding:4px 8px;border-radius:8px;font-size:12px;box-shadow:none" data-action="nav:admin">ê´€ë¦¬ì</button>
          <span>Â·</span>
          <button class="btn secondary" style="padding:4px 8px;border-radius:8px;font-size:12px;box-shadow:none" data-action="nav:results">ê°œí‘œ</button>
          <span>Â·</span>
          <button class="btn secondary" style="padding:4px 8px;border-radius:8px;font-size:12px;box-shadow:none" data-action="open:settings">ì„¤ì •</button>
        </div>
      </div>
    </section>

    <!-- ê´€ë¦¬ì -->
    <section id="view-admin">
      <div class="card" id="adminAuthCard">
        <h2 class="h2">ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
        <div class="field"><label>ë¹„ë°€ë²ˆí˜¸</label><input id="adminPwd" type="password" placeholder="admin" /></div>
        <div class="row"><button class="btn" data-action="admin:login">ë¡œê·¸ì¸</button></div>
      </div>
      <div class="card" id="adminMain" style="display:none">
        <div class="tabs"><div class="tab active" data-tab="design">ì„¤ê³„</div><div class="tab" data-tab="voters">ìœ ê¶Œì</div><div class="tab" data-tab="system">ì‹œìŠ¤í…œ</div></div>
        <!-- ì„¤ê³„ íƒ­ -->
        <div id="tab-design">
          <div class="row" style="justify-content:flex-end"><button class="btn secondary" data-action="pos:add">ì§ìœ„ ì¶”ê°€</button><button class="btn" data-action="design:save">ì €ì¥</button></div>
          <div class="list" id="positionsList"></div>
          <p style="color:var(--g600);font-size:12px">* ë™ì¼ ì§ìœ„ ì¤‘ë³µíˆ¬í‘œ ë¶ˆê°€. ê° ì§ìœ„ëŠ” 1ëª…ë§Œ ì„ íƒí•˜ë„ë¡ ë Œë”ë§ë©ë‹ˆë‹¤.</p>
        </div>
        <!-- ìœ ê¶Œì íƒ­ -->
        <div id="tab-voters" style="display:none">
          <div class="row"><div class="field"><label>ìƒì„± ìˆ˜</label><input id="genCount" type="number" value="30"></div><div class="field"><label>ì ‘ë‘ì‚¬</label><input id="genPrefix" type="text" value="S"></div><button class="btn" data-action="voters:gen">ìƒì„±</button></div>
          <div class="row"><input id="csvFile" type="file" accept=".csv"><button class="btn secondary" data-action="voters:upload">CSV ì—…ë¡œë“œ</button><button class="btn secondary" data-action="voters:preview">ë¯¸ë¦¬ë³´ê¸°</button></div>
          <pre id="votersPreview" class="card" style="white-space:pre;max-height:240px;overflow:auto"></pre>
        </div>
        <!-- ì‹œìŠ¤í…œ íƒ­ -->
        <div id="tab-system" style="display:none">
          <div class="field"><label>ì¤‘ì•™ ì›¹ì•± URL</label><input id="sysWebUrl" type="text" placeholder="https://script.google.com/macros/s/.../exec"></div>
          <div class="field"><label>í•™êµ ì½”ë“œ</label><input id="sysTenant" type="text" placeholder="sch_jeju_elem"></div>
          <div class="row"><button class="btn" data-action="sys:save">ì €ì¥</button><button class="btn secondary" data-action="sys:test">ì—°ê²° í…ŒìŠ¤íŠ¸</button><button class="btn secondary" data-action="sys:init">í…Œë„ŒíŠ¸ ì´ˆê¸°í™”</button><button class="btn secondary" data-action="sys:wipe">íˆ¬í‘œ ì´ˆê¸°í™”</button></div>
        </div>
      </div>
    </section>

    <!-- íˆ¬í‘œ -->
    <section id="view-vote">
      <div class="card"><div class="row" style="justify-content:space-between"><div><h2 class="h2">íˆ¬í‘œ</h2><p>ê³ ìœ ë²ˆí˜¸: <b id="voteVoterId">-</b></p></div><button class="btn secondary" data-action="nav:home">ë©”ì¸ìœ¼ë¡œ</button></div><form id="voteForm" class="list"></form><div class="row" style="justify-content:flex-end"><button class="btn" data-action="vote:submit" disabled>ì œì¶œ</button></div></div>
    </section>

    <!-- ê°œí‘œ -->
    <section id="view-results">
      <div class="card" id="resultsAuthCard"><h2 class="h2">ê°œí‘œ(ê´€ë¦¬ì)</h2><div class="field"><label>ë¹„ë°€ë²ˆí˜¸</label><input id="resultsPwd" type="password" placeholder="admin"></div><div class="row"><button class="btn" data-action="results:login">ì ‘ì†</button></div></div>
      <div class="card" id="resultsMain" style="display:none"><div class="row" style="justify-content:space-between"><h2 class="h2">ì‹¤ì‹œê°„ ê°œí‘œ</h2><div class="row"><button class="btn secondary" data-action="results:refresh">ìƒˆë¡œê³ ì¹¨</button><button class="btn" data-action="results:auto">ìë™ê°±ì‹ : ë”</button></div></div><div class="list" id="resultsWrap"></div></div>
    </section>
  </main>

  <!-- ì„¤ì • ëª¨ë‹¬ -->
  <dialog id="dlgSettings">
    <form method="dialog">
      <h3 class="h3">ì„¤ì •</h3>
      <div class="field"><label>ì¤‘ì•™ ì›¹ì•± URL</label><input id="cfgWebUrl" type="text" placeholder="https://script.google.com/macros/s/.../exec" /></div>
      <div class="field"><label>í•™êµ ì½”ë“œ</label><input id="cfgTenant" type="text" placeholder="sch_xxx" /></div>
      <div class="row"><button class="btn" data-action="cfg:save">ì €ì¥</button><button class="btn secondary" data-action="cfg:close">ë‹«ê¸°</button><button class="btn secondary" data-action="cfg:test">ì—°ê²° í…ŒìŠ¤íŠ¸</button></div>
      <p style="color:var(--g600);font-size:12px">* ìµœì´ˆ ì‚¬ìš© ì‹œ ê´€ë¦¬ì í˜ì´ì§€ â†’ ì‹œìŠ¤í…œ íƒ­ì—ì„œ <b>í…Œë„ŒíŠ¸ ì´ˆê¸°í™”</b> ì‹¤í–‰</p>
    </form>
  </dialog>

  <div id="toast" class="toast"></div>

  <script>
  (function(){
    const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const sections={home:'#view-home',admin:'#view-admin',vote:'#view-vote',results:'#view-results'};
    const AppState={ webAppUrl:localStorage.getItem('webAppUrl')||'', tenant:localStorage.getItem('tenant')||'', adminToken:null, resultsToken:null, voterId:null, autoTimer:null };
    const dlg=$('#dlgSettings');
    function toast(m){ const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1800); }
    function show(name){ Object.values(sections).forEach(sel=> $(sel)?.classList.remove('active')); $(sections[name])?.classList.add('active'); }
    function openDlg(){ try{ dlg.showModal(); }catch(e){ dlg.setAttribute('open',''); } }
    function closeDlg(){ try{ dlg.close(); }catch(e){ dlg.removeAttribute('open'); } }
    function pill(){ $('#pillConn').textContent=(AppState.webAppUrl && AppState.tenant)? `ì—°ê²°ë¨Â·${AppState.tenant}`:'ë¯¸ì„¤ì •'; }

    // API (ë°±ì—”ë“œ ì—°ê²°; ì„¤ì • ì—†ìœ¼ë©´ í˜¸ì¶œí•˜ì§€ ë§ ê²ƒ)
    const API={
      async call(path, method='GET', body=null, {auth=null}={}){
        if(!AppState.webAppUrl) throw new Error('ì›¹ì•± ë¯¸ì„¤ì •'); if(!AppState.tenant) throw new Error('í•™êµì½”ë“œ ë¯¸ì„¤ì •');
        const url=new URL(AppState.webAppUrl); url.searchParams.set('path', path); url.searchParams.set('tenant', AppState.tenant);
        const opt={method, headers:{'Content-Type':'application/json'}}; if(body) opt.body=JSON.stringify(body); if(auth) opt.headers['X-Auth']=auth;
        const res=await fetch(url.toString(),opt); if(!res.ok) throw new Error('ìš”ì²­ ì‹¤íŒ¨ '+res.status); return res.json();
      },
      init(){ return this.call('/init','POST',{}); },
      adminLogin(pwd){ return this.call('/auth/admin/login','POST',{password_plain:pwd}); },
      getDesign(){ return this.call('/design','GET'); },
      saveDesign(token,data){ return this.call('/design','POST',data,{auth:token}); },
      votersPreview(){ return this.call('/voters/preview','GET'); },
      votersGenerate(token,count,prefix){ return this.call('/voters/generate','POST',{count,prefix},{auth:token}); },
      votersUpload(token,rows){ return this.call('/voters/upload','POST',{rows},{auth:token}); },
      voteValidate(voter_id){ return this.call('/vote/validate','POST',{voter_id}); },
      voteSubmit(voter_id,selections,fingerprint){ return this.call('/vote/submit','POST',{voter_id,selections,fingerprint}); },
      getResults(token){ return this.call('/results','GET',null,{auth:token}); },
      wipeVotes(token){ return this.call('/admin/wipe','POST',{}, {auth:token}); },
      ensureSchema(token){ return this.call('/admin/initSchema','POST',{}, {auth:token}); },
    };

    // ì„¤ê³„ í¸ì§‘ UI
    const positionsList=()=> $('#positionsList');
    function newPosition(){ const id='P'+Math.random().toString(36).slice(2,6).toUpperCase(); return {position_id:id,title:'ìƒˆ ì§ìœ„',order:0,enabled:true,_cands:[newCandidate(id)]}; }
    function newCandidate(position_id){ const id='C'+Math.random().toString(36).slice(2,6).toUpperCase(); return {position_id,candidate_id:id,name:'',class:'',description:'',photo_url:'',order:0,enabled:true}; }
    function createCandidateChip(c){ const chip=document.createElement('div'); chip.className='candidate-chip'; chip.dataset.cid=c.candidate_id; chip.innerHTML=`<input class="cand-name" type="text" placeholder="ì´ë¦„" value="${c.name||''}" /><input class="cand-class" type="text" placeholder="í•™ê¸‰(ì„ íƒ)" value="${c.class||''}" /><input class="cand-photo" type="text" placeholder="ì‚¬ì§„ URL(ì„ íƒ)" value="${c.photo_url||''}" style="flex:1" /><button class="btn secondary" data-action="cand:del">ì‚­ì œ</button>`; return chip; }
    function createPositionCard(p){ const el=document.createElement('div'); el.className='position-card'; el.dataset.pid=p.position_id; el.innerHTML=`<div class="row" style="justify-content:space-between;align-items:center"><input class="pos-title" type="text" value="${p.title}" style="font-weight:700"/><div class="row"><label class="row" style="gap:6px;align-items:center"><input class="pos-enabled" type="checkbox" ${p.enabled?'checked':''}/> í™œì„±</label><button class="btn secondary" data-action="cand:add">í›„ë³´ ì¶”ê°€</button><button class="btn secondary" data-action="pos:del">ì‚­ì œ</button></div></div><div class="list candidates" style="margin-top:8px"></div>`; const wrap=el.querySelector('.candidates'); p._cands.forEach(c=> wrap.appendChild(createCandidateChip(c))); return el; }

    async function loadDesign(){ const list=positionsList(); if(!list) return; list.innerHTML='<div>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>'; try{ const d=await API.getDesign(); list.innerHTML=''; const map={}; (d.positions||[]).sort((a,b)=>(a.order||0)-(b.order||0)).forEach(p=>{p._cands=[]; map[p.position_id]=p;}); (d.candidates||[]).forEach(c=> map[c.position_id]? map[c.position_id]._cands.push(c):null); Object.values(map).forEach(p=> list.appendChild(createPositionCard(p))); }catch(err){ console.error(err); list.innerHTML='<div>ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>'; }
    }

    async function buildVoteForm(){ const wrap=$('#voteForm'); if(!wrap) return; wrap.innerHTML=''; try{ const d=await API.getDesign(); const byPos={}; (d.candidates||[]).forEach(c=> ((byPos[c.position_id] ||= []).push(c))); (d.positions||[]).sort((a,b)=>(a.order||0)-(b.order||0)).forEach(p=>{ const card=document.createElement('div'); card.className='position-card'; card.dataset.pid=p.position_id; card.innerHTML=`<div class="row" style="justify-content:space-between;align-items:center"><div class="h3">${p.title}</div><span class="pill">ë‹¨ì¼ ì„ íƒ</span></div>`; const list=document.createElement('div'); list.className='list'; (byPos[p.position_id]||[]).sort((a,b)=>(a.order||0)-(b.order||0)).forEach(c=>{ const row=document.createElement('label'); row.className='candidate-chip'; row.innerHTML=`<input type="radio" name="${p.position_id}" value="${c.candidate_id}" /><div style="display:flex;gap:10px;align-items:center"><div style="width:32px;height:32px;border-radius:999px;background:var(--g100);display:flex;align-items:center;justify-content:center">${(c.name||'').slice(0,1)}</div><div><div style="font-weight:700">${c.name||''}</div><div style="font-size:12px;color:var(--g600)">${c.class||''}</div></div></div>`; list.appendChild(row); }); card.appendChild(list); wrap.appendChild(card); }); $('[data-action="vote:submit"]').disabled=false; }catch(err){ console.error(err); wrap.innerHTML='<div>ì„¤ê³„ ë¡œë“œ ì‹¤íŒ¨</div>'; }}

    async function previewVoters(){ try{ const r=await API.votersPreview(); const lines=['voter_id,class,name,used,last_vote_ts']; (r.voters||[]).forEach(v=> lines.push([v.voter_id,v.class||'',v.name||'',v.used?'TRUE':'FALSE',v.last_vote_ts||''].join(','))); $('#votersPreview').textContent=lines.join('\n'); }catch(err){ console.error(err); toast('ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨'); }}

    async function renderResults(){ try{ const r=await API.getResults(AppState.resultsToken); const wrap=$('#resultsWrap'); wrap.innerHTML=''; (r.results||[]).forEach(pos=>{ const total=(pos.items||[]).reduce((a,b)=> a+(b.votes||0),0)||1; const card=document.createElement('div'); card.className='card'; card.innerHTML=`<div class="h3">${pos.title}</div>`; (pos.items||[]).forEach(it=>{ const rate=((it.votes||0)/total*100); const row=document.createElement('div'); row.innerHTML=`<div class="row" style="justify-content:space-between;align-items:center"><div>${it.name}</div><div class="row" style="gap:8px"><b>${it.votes}</b><span style="color:var(--g600)">(${rate.toFixed(1)}%)</span></div></div><div style="height:8px;background:var(--g100);border-radius:999px;overflow:hidden"><i style="display:block;height:100%;background:var(--blue);width:${rate}%"></i></div>`; card.appendChild(row); }); wrap.appendChild(card); }); }catch(err){ console.error(err); toast('ê²°ê³¼ ë¡œë“œ ì‹¤íŒ¨'); }
    }

    // ì „ì—­ ì´ë²¤íŠ¸ ìœ„ì„ (í´ë¦­)
    document.addEventListener('click', async (ev)=>{
      const btn = ev.target.closest('[data-action]');
      if(!btn) return;
      // ëª¨ë“  ë²„íŠ¼ì€ ê¸°ë³¸ì ìœ¼ë¡œ submit ë°©ì§€
      if(btn.tagName==='BUTTON' && !btn.getAttribute('type')) btn.setAttribute('type','button');
      const act = btn.getAttribute('data-action');
      try{
        // ë„¤ë¹„ê²Œì´ì…˜
        if(act==='nav:home') return show('home');
        if(act==='nav:admin') return show('admin');
        if(act==='nav:vote') return show('vote');
        if(act==='nav:results') return show('results');

        // ì„¤ì • ëª¨ë‹¬
        if(act==='open:settings'){ $('#cfgWebUrl').value=AppState.webAppUrl||''; $('#cfgTenant').value=AppState.tenant||''; return openDlg(); }
        if(act==='cfg:close') return (ev.preventDefault(), closeDlg());
        if(act==='cfg:save'){
          ev.preventDefault(); const w=$('#cfgWebUrl').value.trim(); const t=$('#cfgTenant').value.trim(); if(!w||!t) return toast('ì›¹ì•±URL/í•™êµì½”ë“œ ì…ë ¥');
          AppState.webAppUrl=w; AppState.tenant=t; localStorage.setItem('webAppUrl',w); localStorage.setItem('tenant',t); pill(); closeDlg(); return toast('ì €ì¥ë¨');
        }
        if(act==='cfg:test'){
          ev.preventDefault(); const w=$('#cfgWebUrl').value.trim(); const t=$('#cfgTenant').value.trim(); if(!w||!t) return toast('ì›¹ì•±URL/í•™êµì½”ë“œ ì…ë ¥');
          AppState.webAppUrl=w; AppState.tenant=t; pill(); try{ await API.init(); toast('ì—°ê²° ì„±ê³µ'); }catch(err){ console.error(err); toast('ì—°ê²° ì‹¤íŒ¨'); } return;
        }

        // ë©”ì¸ íˆ¬í‘œ ì‹œì‘
        if(act==='vote:start'){
          const id=$('#inputVoterId').value.trim(); if(!id) return toast('ê³ ìœ ë²ˆí˜¸ ì…ë ¥');
          try{ const r=await API.voteValidate(id); if(!r.allowed) throw new Error('not-allowed'); AppState.voterId=id; $('#voteVoterId').textContent=id; await buildVoteForm(); return show('vote'); }
          catch(err){ console.error(err); return toast('ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ì´ë¯¸ íˆ¬í‘œë¨'); }
        }
        if(act==='vote:submit'){
          const selections=[]; $$('#voteForm .position-card').forEach(card=>{ const name=card.dataset.pid; const sel=card.querySelector(`input[name="${name}"]:checked`); if(sel) selections.push({position_id:name,candidate_id:sel.value}); });
          if(!selections.length) return toast('ì„ íƒ í›„ ì œì¶œ');
          try{ await API.voteSubmit(AppState.voterId, selections, navigator.userAgent.slice(0,120)); toast('íˆ¬í‘œ ì™„ë£Œ!'); AppState.voterId=null; return show('home'); }
          catch(err){ console.error(err); return toast('ì œì¶œ ì‹¤íŒ¨'); }
        }

        // ê´€ë¦¬ì ë¡œê·¸ì¸/íƒ­
        if(act==='admin:login'){
          const pwd=$('#adminPwd').value; if(!pwd) return toast('ë¹„ë°€ë²ˆí˜¸ ì…ë ¥');
          try{ const r=await API.adminLogin(pwd); AppState.adminToken=r.token; $('#adminAuthCard').style.display='none'; $('#adminMain').style.display='block'; await loadDesign(); }
          catch(err){ console.error(err); toast('ì¸ì¦ ì‹¤íŒ¨'); }
          return;
        }
        if(act==='pos:add'){
          positionsList()?.prepend(createPositionCard(newPosition()));
          return;
        }
        if(act==='design:save'){
          const positions=[], candidates=[]; $$('#positionsList .position-card').forEach((pc,idx)=>{
            const pid=pc.dataset.pid; const title=pc.querySelector('.pos-title').value.trim(); const enabled=pc.querySelector('.pos-enabled').checked; positions.push({position_id:pid,title,enabled,order:idx+1});
            pc.querySelectorAll('.candidate-chip').forEach((cc,cidx)=>{ candidates.push({position_id:pid,candidate_id:cc.dataset.cid,name:cc.querySelector('.cand-name').value.trim(),class:cc.querySelector('.cand-class').value.trim(),photo_url:cc.querySelector('.cand-photo').value.trim(),enabled:true,order:cidx+1}); });
          });
          try{ await API.saveDesign(AppState.adminToken,{positions,candidates}); toast('ì €ì¥ ì™„ë£Œ'); }catch(err){ console.error(err); toast('ì €ì¥ ì‹¤íŒ¨'); }
          return;
        }
        if(act==='cand:add'){
          const card=btn.closest('.position-card'); const pid=card?.dataset.pid; if(!pid) return; const wrap=card.querySelector('.candidates'); wrap.appendChild(createCandidateChip(newCandidate(pid))); return;
        }
        if(act==='pos:del') { btn.closest('.position-card')?.remove(); return; }
        if(act==='cand:del'){ btn.closest('.candidate-chip')?.remove(); return; }

        // ìœ ê¶Œì
        if(act==='voters:gen'){
          const count=parseInt($('#genCount').value||'0',10); const prefix=$('#genPrefix').value||'S'; if(!count) return toast('ìƒì„± ìˆ˜ ì…ë ¥'); try{ await API.votersGenerate(AppState.adminToken,count,prefix); toast('ìƒì„± ì™„ë£Œ'); await previewVoters(); }catch(err){ console.error(err); toast('ìƒì„± ì‹¤íŒ¨'); } return;
        }
        if(act==='voters:preview') return previewVoters();
        if(act==='voters:upload'){
          const f=$('#csvFile').files[0]; if(!f) return toast('CSV ì„ íƒ'); const txt=await f.text(); const rows=txt.split(/\r?\n/).slice(1).map(l=> l.split(',')).filter(a=> a.length>=2).map(a=> ({class:a[0]?.trim(), name:a[1]?.trim()})); try{ await API.votersUpload(AppState.adminToken, rows); toast('ì—…ë¡œë“œ ì™„ë£Œ'); await previewVoters(); }catch(err){ console.error(err); toast('ì—…ë¡œë“œ ì‹¤íŒ¨'); } return;
        }

        // ì‹œìŠ¤í…œ
        if(act==='sys:save'){ const w=$('#sysWebUrl').value.trim(); const t=$('#sysTenant').value.trim(); if(!w||!t) return toast('ì›¹ì•±URL/í•™êµì½”ë“œ ì…ë ¥'); AppState.webAppUrl=w; AppState.tenant=t; localStorage.setItem('webAppUrl',w); localStorage.setItem('tenant',t); pill(); return toast('ì €ì¥ë¨'); }
        if(act==='sys:test'){ try{ await API.init(); toast('ì—°ê²° ì„±ê³µ'); }catch(err){ console.error(err); toast('ì—°ê²° ì‹¤íŒ¨'); } return; }
        if(act==='sys:init'){ try{ await API.ensureSchema(AppState.adminToken); toast('í…Œë„ŒíŠ¸ ì´ˆê¸°í™” ì™„ë£Œ'); }catch(err){ console.error(err); toast('ì‹¤íŒ¨'); } return; }
        if(act==='sys:wipe'){ if(!confirm('íˆ¬í‘œ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?')) return; try{ await API.wipeVotes(AppState.adminToken); toast('ì´ˆê¸°í™” ì™„ë£Œ'); }catch(err){ console.error(err); toast('ì‹¤íŒ¨'); } return; }

        // ê°œí‘œ
        if(act==='results:login'){ const pwd=$('#resultsPwd').value; if(!pwd) return toast('ë¹„ë°€ë²ˆí˜¸ ì…ë ¥'); try{ const r=await API.adminLogin(pwd); AppState.resultsToken=r.token; $('#resultsAuthCard').style.display='none'; $('#resultsMain').style.display='block'; await renderResults(); }catch(err){ console.error(err); toast('ì¸ì¦ ì‹¤íŒ¨'); } return; }
        if(act==='results:refresh') return renderResults();
        if(act==='results:auto'){ if(AppState.autoTimer){ clearInterval(AppState.autoTimer); AppState.autoTimer=null; btn.textContent='ìë™ê°±ì‹ : ë”'; } else { AppState.autoTimer=setInterval(renderResults,2500); btn.textContent='ìë™ê°±ì‹ : ì¼¬'; } return; }

      }catch(err){ console.error('[handler]', err); toast('ë™ì‘ ì¤‘ ì˜¤ë¥˜'); }
    });

    window.addEventListener('DOMContentLoaded', ()=>{ // ê¸°ë³¸ í‘œì‹œ & ë²„íŠ¼ type ë³´ì •
      document.querySelectorAll('button').forEach(b=>{ if(!b.getAttribute('type')) b.setAttribute('type','button'); });
      show('home'); pill();
    });

    window.addEventListener('error', (e)=>{ try{ const t=document.getElementById('toast'); if(t){ t.textContent='ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜: '+(e?.message||''); t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2500);} }catch(_){} console.error('[GLOBAL ERROR]', e); });
  })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <title>ì‹ ë‚¨ ì¢Œì„ ë§¤ë§¤Â·ì„ëŒ€ì¥ Â· Pastel v7</title>
    <meta name="theme-color" content="#ffffff" />
    <style>
      :root{
        --bg:#ffffff;--text:#1f2937;--muted:#6b7280;--border:#e5e7eb;--card:#f8fafc;--brand:#6366f1;
        --vacant:#ffe4e6;--vacant-b:#fecdd3;--rent:#e0f2fe;--rent-b:#bae6fd;--board:#ecfdf5;--board-b:#a7f3d0;
      }
      html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
      *{box-sizing:border-box}
      .container{max-width:1100px;margin:0 auto;padding:20px 14px 80px}
      .hstack{display:flex;align-items:center;gap:8px}
      .between{display:flex;align-items:center;justify-content:space-between;gap:8px}
      .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#f9fafb;cursor:pointer}
      .btn:hover{background:#f3f4f6}
      .btn-ghost{padding:6px 10px;border-radius:10px;border:1px dashed var(--border);background:transparent;cursor:pointer}
      .input{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#fff;color:#111827;width:100%}
      .select{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#fff;color:#111827}
      .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}
      .badge{font-size:12px;padding:2px 6px;border-radius:999px;border:1px solid var(--border);background:#fff;color:#374151}
      .title-sm{font-size:13px;color:var(--muted);margin-bottom:6px;font-weight:600}
      .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
      .grid24{display:grid;grid-template-rows:repeat(4,auto);gap:8px}
      .row2{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
      .board{margin-top:12px;padding:6px 10px;font-size:13px;text-align:center;border-radius:12px;background:var(--board);color:#047857;border:1px solid var(--board-b)}
      .summary{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:14px;text-align:center}
      .summary .card{font-size:13px}
      .seat{position:relative;padding:10px;border-radius:12px;text-align:left;border:1px solid var(--border);background:#fff;cursor:pointer;display:flex;flex-direction:column;gap:4px;transition:transform .06s ease, box-shadow .12s ease, opacity .12s}
      .seat:hover{transform:translateY(-1px);box-shadow:0 4px 14px rgba(0,0,0,.06)}
      .seat .top{display:flex;justify-content:space-between;align-items:center}
      .label{font-size:13px;font-weight:800;color:#374151}
      .line{font-size:12px;color:#374151;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
      .price{font-size:12px;font-weight:700;color:#111827}
      .price .muted{color:var(--muted);font-weight:400}
      .pill{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#fff}
      .seg{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}
      .seg button{padding:6px 10px;border:0;background:#fff;cursor:pointer}
      .seg button.active{background:#eef2ff;color:#4338ca}
      .ring{outline:2px solid #a5b4fc}
      .muted-opa{opacity:.35}
      /* modal */
      .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:50}
      .modal{background:#fff;border:1px solid var(--border);border-radius:14px;padding:16px;width:480px;max-width:92vw}
      .field{display:flex;flex-direction:column;gap:4px}
      .cols{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
      .tiny{font-size:12px;color:var(--muted)}
      .w-clip{width:min(160px,42vw)}
      @media (max-width:900px){.grid3{grid-template-columns:1fr}} 
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const {useState,useMemo,useEffect} = React;

      // storage helpers
      const isClient = typeof window!=="undefined";
      const safeGet=(k,f=null)=>{if(!isClient)return f;try{return localStorage.getItem(k)??f;}catch{return f;}};
      const safeSet=(k,v)=>{if(!isClient)return;try{localStorage.setItem(k,v);}catch{}};

      // keys (v7)
      const STORAGE_KEY="seat-market-v7";
      const PIN_KEY="seat-market-pin";const LOCK_KEY="seat-market-locked";const BOARD_KEY="seat-market-board-top";
      const DENSITY_KEY="seat-market-density";const WRAP_KEY="seat-market-wrap";const SHOW_PRICE_BADGE_KEY="seat-market-price-badge";

      // utils
      const KRW=(n)=>(Number(n)||0).toLocaleString("ko-KR",{maximumFractionDigits:0})+"ì›";
      const now=()=>new Date().toISOString();
      const labels=()=>{const a=[];for(let b=1;b<=3;b++){for(let r=0;r<4;r++){const ch=String.fromCharCode(65+r);for(let c=1;c<=2;c++)a.push(`${b}${ch}${c}`)}}return a};

      const defSeats=()=>labels().map((label,i)=>({id:i+1,label,block:Number(label[0]),row:label[1],col:Number(label[2]),owner:"",tenant:"",price:0,rentFee:0,lastUpdated:now(),history:[]}));

      const loadState=()=>{try{const raw=safeGet(STORAGE_KEY);if(!raw)return defSeats();const p=JSON.parse(raw);if(!Array.isArray(p)||p.length!==24)return defSeats();return p;}catch{return defSeats();}};
      const saveState=(seats)=>safeSet(STORAGE_KEY,JSON.stringify(seats));

      const loadPin=()=>safeGet(PIN_KEY,"");const savePin=(v)=>safeSet(PIN_KEY,v||"");
      const loadLocked=()=>safeGet(LOCK_KEY,"true")==="true";const saveLocked=(v)=>safeSet(LOCK_KEY,String(!!v));
      const loadBoard=()=>safeGet(BOARD_KEY,"true")==="true";const saveBoard=(v)=>safeSet(BOARD_KEY,String(!!v));
      const loadDensity=()=>safeGet(DENSITY_KEY,"medium");const saveDensity=(v)=>safeSet(DENSITY_KEY,v);
      const loadWrap=()=>safeGet(WRAP_KEY,"false")==="true";const saveWrap=(v)=>safeSet(WRAP_KEY,String(!!v));
      const loadPriceBadge=()=>safeGet(SHOW_PRICE_BADGE_KEY,"true")==="true";const savePriceBadge=(v)=>safeSet(SHOW_PRICE_BADGE_KEY,String(!!v));

      function App(){
        const [seats,setSeats]=useState(loadState);
        const [q,setQ]=useState("");
        const [sort,setSort]=useState("label");
        const [pin,setPin]=useState(loadPin);
        const [locked,setLocked]=useState(loadLocked);
        const [boardTop,setBoardTop]=useState(loadBoard);
        const [density,setDensity]=useState(loadDensity);
        const [wrap,setWrap]=useState(loadWrap);
        const [showPriceBadge,setShowPriceBadge]=useState(loadPriceBadge);
        const [exportOpen,setExportOpen]=useState(false);
        const [importOpen,setImportOpen]=useState(false);
        const [editOpen,setEditOpen]=useState(false);
        const [activeId,setActiveId]=useState(null);
        const [undoStack,setUndoStack]=useState([]);

        useEffect(()=>saveState(seats),[seats]);
        useEffect(()=>savePin(pin),[pin]);
        useEffect(()=>saveLocked(locked),[locked]);
        useEffect(()=>saveBoard(boardTop),[boardTop]);
        useEffect(()=>saveDensity(density),[density]);
        useEffect(()=>saveWrap(wrap),[wrap]);
        useEffect(()=>savePriceBadge(showPriceBadge),[showPriceBadge]);

        // derived
        const qText=q.trim().toLowerCase();
        const matchSeat=(s)=>!qText||s.label.toLowerCase().includes(qText)||s.owner.toLowerCase().includes(qText)||s.tenant.toLowerCase().includes(qText);
        const sorted=useMemo(()=>{
          const list=[...seats];
          if(sort==="priceDesc") list.sort((a,b)=>b.price-a.price);
          else if(sort==="priceAsc") list.sort((a,b)=>a.price-b.price);
          else if(sort==="vacant") list.sort((a,b)=>(a.tenant?1:0)-(b.tenant?1:0));
          else list.sort((a,b)=>a.label.localeCompare(b.label,"ko"));
          return list;
        },[seats,sort]);

        const stats=useMemo(()=>{
          const total=seats.reduce((acc,s)=>acc+(Number(s.price)||0),0);
          const avg=total/seats.length;const max=seats.slice().sort((a,b)=>b.price-a.price)[0];
          return {total,avg,max};
        },[seats]);

        // undo & guard
        const pushUndo=(prev)=>setUndoStack(st=>[JSON.stringify(prev),...st].slice(0,15));
        const undo=()=>{if(!undoStack.length)return alert("ë˜ëŒë¦´ ê¸°ë¡ì´ ì—†ìŒ");const [top,...rest]=undoStack;setSeats(JSON.parse(top));setUndoStack(rest)};
        const requireEdit=(fn)=>{if(!pin)return fn();if(!locked)return fn();const input=prompt("í¸ì§‘ PIN ì…ë ¥");if(input===pin)fn();else alert("PIN ë¶ˆì¼ì¹˜")};

        const updateSeat=(id,patch,note)=>{
          setSeats(prev=>{const snap=prev.map(s=>({...s}));pushUndo(snap);return prev.map(s=>s.id===id?{...s,...patch,lastUpdated:now(),history:note?[{time:now(),note},...(s.history||[])].slice(0,20):s.history}:s)});
        };

        const resetAll=()=>{if(!confirm("ì „ì²´ ì´ˆê¸°í™”í•¨? (ë˜ëŒë¦¬ê¸° ê°€ëŠ¥)"))return;pushUndo(seats);setSeats(defSeats())};

        const active=seats.find(s=>s.id===activeId)||null;

        // density â†’ min height
        const seatMinH = density==="small" ? (wrap?78:64) : density==="large" ? (wrap?122:96) : (wrap?100:80);
        const seatStyle=(vacant)=>({background:vacant?"var(--vacant)":"var(--rent)",borderColor:vacant?"var(--vacant-b)":"var(--rent-b)",minHeight:seatMinH});

        return (
          <div className="container">
            {/* header */}
            <div className="between">
              <div className="hstack">
                <div style={{width:38,height:38,borderRadius:12,background:"#f3f4f6",border:"1px solid var(--border)",display:"flex",alignItems:"center",justifyContent:"center"}}>ğŸ’</div>
                <div>
                  <div style={{fontWeight:800}}>ì‹ ë‚¨ ì¢Œì„ ë§¤ë§¤Â·ì„ëŒ€ì¥</div>
                  <div className="tiny">3ë¶„ë‹¨(2Ã—4) = 24ì„ Â· ë¡œì»¬ ì €ì¥</div>
                </div>
              </div>
              <div className="hstack">
                <button className="btn" onClick={undo}>âª ë˜ëŒë¦¬ê¸°</button>
                <details>
                  <summary className="btn">âš™ï¸ ì„¤ì •</summary>
                  <div className="card" style={{marginTop:6,minWidth:300}}>
                    <div className="title-sm">ë³´ì•ˆ/ë°ì´í„°</div>
                    <div className="between"><span>í¸ì§‘ ì ê¸ˆ</span><input type="checkbox" checked={locked} onChange={e=>setLocked(e.target.checked)} /></div>
                    <div className="between" style={{marginTop:6}}><span>PIN</span><input className="input" style={{width:120}} value={pin} onChange={e=>setPin(e.target.value)} placeholder="ìˆ«ì 4ìë¦¬" /></div>
                    <hr style={{border:0,borderTop:"1px solid var(--border)",margin:"10px 0"}}/>
                    <div className="title-sm">ë°°ì¹˜/í‘œì‹œ</div>
                    <button className="btn" onClick={()=>setBoardTop(v=>!v)}>ì¹ íŒ ìœ„ì¹˜ ì „í™˜ (í˜„ì¬ {boardTop?"ìƒë‹¨":"í•˜ë‹¨"})</button>
                    <div className="between" style={{marginTop:8}}>
                      <span>ì¹¸ í¬ê¸°</span>
                      <div className="seg">
                        {(["small","medium","large"]).map(d=>(
                          <button key={d} className={density===d?"active":""} onClick={()=>setDensity(d)}>{d==="small"?"ì‘ê²Œ":d==="medium"?"ë³´í†µ":"í¬ê²Œ"}</button>
                        ))}
                      </div>
                    </div>
                    <div className="between" style={{marginTop:8}}><span>í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ</span><input type="checkbox" checked={wrap} onChange={e=>setWrap(e.target.checked)} /></div>
                    <div className="between" style={{marginTop:8}}><span>ê°€ê²© ë°°ì§€ í‘œì‹œ</span><input type="checkbox" checked={showPriceBadge} onChange={e=>setShowPriceBadge(e.target.checked)} /></div>
                    <hr style={{border:0,borderTop:"1px solid var(--border)",margin:"10px 0"}}/>
                    <div className="hstack">
                      <button className="btn" onClick={()=>setExportOpen(true)}>ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
                      <button className="btn" onClick={()=>setImportOpen(true)}>ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</button>
                      <button className="btn" onClick={resetAll}>ì „ì²´ ì´ˆê¸°í™”</button>
                    </div>
                  </div>
                </details>
              </div>
            </div>

            {/* search/sort */}
            <div className="hstack" style={{marginTop:10}}>
              <input className="input" style={{flex:1}} placeholder="ì¢Œì„ ë¼ë²¨(ì˜ˆ: 2B1), ì†Œìœ ì£¼, ì„ì°¨ì¸ ê²€ìƒ‰" value={q} onChange={e=>setQ(e.target.value)} />
              <select className="select" value={sort} onChange={e=>setSort(e.target.value)}>
                <option value="label">ë¼ë²¨ìˆœ</option>
                <option value="priceDesc">ê°€ê²© ë†’ì€ìˆœ</option>
                <option value="priceAsc">ê°€ê²© ë‚®ì€ìˆœ</option>
                <option value="vacant">ë¹ˆìë¦¬ ìš°ì„ </option>
              </select>
            </div>

            {boardTop && <div className="board">ğŸ§‘â€ğŸ« ì¹ íŒ (êµíƒ) â€” ì´ìª½ì´ ì•</div>}

            {/* seat grid */}
            <div className="grid3">
              {[1,2,3].map(block=> (
                <div key={block} className="card">
                  <div className="title-sm">{block}ë¶„ë‹¨</div>
                  <div className="grid24">
                    {Array.from({length:4}).map((_,r)=> (
                      <div key={r} className="row2">
                        {Array.from({length:2}).map((_,c)=>{
                          const row=String.fromCharCode(65+r);const col=c+1;const label=`${block}${row}${col}`;
                          const seat=seats.find(s=>s.label===label);
                          const vacant=!seat?.tenant;const match=matchSeat(seat);
                          return (
                            <button key={label} className={`seat ${match?"ring":""} ${qText&&!match?"muted-opa":""}`} style={{...seatStyle(vacant)}} onClick={()=>{setActiveId(seat.id);setEditOpen(true);}}>
                              <div className="top">
                                <div className="label">{label}</div>
                                <span className="badge" style={{display:showPriceBadge?"inline-flex":"none"}}>{KRW(seat.price)}</span>
                              </div>
                              <div className="line" style={{whiteSpace:wrap?"normal":"nowrap"}}>ì†Œìœ ì£¼: {seat.owner || "-"}</div>
                              <div className="line" style={{whiteSpace:wrap?"normal":"nowrap"}}>ì„ì°¨ì¸: {seat.tenant || "-"}</div>
                              <div className="price">{vacant?"":<span className="tiny">ì„ëŒ€ë£Œ <span className="muted">{KRW(seat.rentFee)}</span></span>}</div>
                            </button>
                          );
                        })}
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>

            {!boardTop && <div className="board">ğŸ§‘â€ğŸ« ì¹ íŒ (êµíƒ) â€” ì´ìª½ì´ ì•</div>}

            {/* summary */}
            <div className="summary">
              <div className="card"><div className="tiny">ì´ ì‹œê°€</div><div style={{fontWeight:800}}>{KRW(stats.total)}</div></div>
              <div className="card"><div className="tiny">í‰ê· ê°€</div><div style={{fontWeight:800}}>{KRW(stats.avg)}</div></div>
              <div className="card"><div className="tiny">ìµœê³ ê°€</div><div style={{fontWeight:800}}>{stats.max?`${stats.max.label} Â· ${KRW(stats.max.price)}`:"-"}</div></div>
            </div>

            {/* edit modal */}
            {editOpen && active && (
              <div className="backdrop" onClick={()=>setEditOpen(false)}>
                <div className="modal" onClick={(e)=>e.stopPropagation()}>
                  <div style={{fontWeight:800,marginBottom:8}}>ì¢Œì„ ì •ë³´ ìˆ˜ì •</div>
                  <div className="tiny" style={{marginBottom:8}}>ë¼ë²¨: <b style={{color:"#111827"}}>{active.label}</b></div>
                  <div className="cols">
                    <div className="field">
                      <div className="tiny">ì†Œìœ ì£¼</div>
                      <input className="input w-clip" value={active.owner} onChange={e=>requireEdit(()=>updateSeat(active.id,{owner:e.target.value},`ì†Œìœ ì£¼ â†’ ${e.target.value}`))} />
                    </div>
                    <div className="field">
                      <div className="tiny">ì„ì°¨ì¸</div>
                      <input className="input w-clip" value={active.tenant} onChange={e=>requireEdit(()=>updateSeat(active.id,{tenant:e.target.value},`ì„ì°¨ì¸ â†’ ${e.target.value}`))} />
                    </div>
                  </div>
                  <div className="cols" style={{marginTop:8}}>
                    <div className="field">
                      <div className="tiny">ê°€ê²©</div>
                      <input type="number" className="input w-clip" value={active.price} onChange={e=>requireEdit(()=>updateSeat(active.id,{price:Number(e.target.value||0)},`ê°€ê²© â†’ ${e.target.value}`))} />
                    </div>
                    <div className="field">
                      <div className="tiny">ì„ëŒ€ë£Œ</div>
                      <input type="number" className="input w-clip" value={active.rentFee} onChange={e=>requireEdit(()=>updateSeat(active.id,{rentFee:Number(e.target.value||0)},`ì„ëŒ€ë£Œ â†’ ${e.target.value}`))} />
                    </div>
                  </div>
                  <div className="hstack" style={{justifyContent:"flex-end",marginTop:12}}>
                    <button className="btn-ghost" onClick={()=>requireEdit(()=>updateSeat(active.id,{owner:"",tenant:"",price:0,rentFee:0},"ì¢Œì„ ì´ˆê¸°í™”"))}>ì´ˆê¸°í™”</button>
                    <button className="btn" onClick={()=>setEditOpen(false)}>ë‹«ê¸°</button>
                  </div>
                </div>
              </div>
            )}

            {/* export */}
            {exportOpen && (
              <div className="backdrop" onClick={()=>setExportOpen(false)}>
                <div className="modal" onClick={(e)=>e.stopPropagation()}>
                  <div style={{fontWeight:800,marginBottom:8}}>ë°ì´í„° ë‚´ë³´ë‚´ê¸° (JSON)</div>
                  <textarea readonly className="input" style={{height:220}} value={JSON.stringify(seats,null,2)}></textarea>
                  <div className="hstack" style={{justifyContent:"flex-end",marginTop:12}}>
                    <button className="btn" onClick={()=>{navigator.clipboard.writeText(JSON.stringify(seats));alert("ë³µì‚¬ë¨")}}>ë³µì‚¬</button>
                    <button className="btn" onClick={()=>setExportOpen(false)}>ë‹«ê¸°</button>
                  </div>
                </div>
              </div>
            )}

            {/* import */}
            {importOpen && (
              <ImportModal onClose={()=>setImportOpen(false)} onLoad={(data)=>{ if(!Array.isArray(data)||data.length!==24) return alert("í˜•ì‹ ì˜¤ë¥˜: ë°°ì—´ 24ê°œ í•„ìš”"); requireEdit(()=>setSeats(data)); setImportOpen(false); }} />
            )}
          </div>
        );
      }

      function ImportModal({onClose,onLoad}){
        const [raw,setRaw]=useState("");
        return (
          <div className="backdrop" onClick={onClose}>
            <div className="modal" onClick={(e)=>e.stopPropagation()}>
              <div style={{fontWeight:800,marginBottom:8}}>ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (JSON ë¶™ì—¬ë„£ê¸°)</div>
              <textarea className="input" style={{height:220}} placeholder="ì—¬ê¸°ì— JSON ë¶™ì—¬ë„£ê¸°" value={raw} onChange={e=>setRaw(e.target.value)} />
              <div className="hstack" style={{justifyContent:"flex-end",marginTop:12}}>
                <button className="btn" onClick={()=>{try{const data=JSON.parse(raw);onLoad(data);}catch{alert("JSON íŒŒì‹± ì˜¤ë¥˜")}}}>ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button className="btn" onClick={onClose}>ë‹«ê¸°</button>
              </div>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
    </script>
  </body>
</html>
