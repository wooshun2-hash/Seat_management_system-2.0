<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>전교임원선거 · 통합 안정판</title>
  <style>
    :root{--blue:#2563eb;--blue2:#1d4ed8;--b50:#eff6ff;--g50:#f9fafb;--g100:#f3f4f6;--g200:#e5e7eb;--g600:#4b5563;--g900:#111827;--sh:0 10px 25px rgba(0,0,0,.08)}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Apple SD Gothic Neo,Noto Sans KR,Arial;color:var(--g900);background:#fff}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--g200);z-index:20}
    .nav{max-width:1080px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
    .brand{font-weight:800;display:flex;gap:10px;align-items:center}
    .logo{width:28px;height:28px;border-radius:10px;background:linear-gradient(135deg,var(--blue),var(--blue2))}
    .grow{flex:1}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;background:var(--blue);color:#fff;font-weight:700;cursor:pointer;box-shadow:var(--sh)}
    .btn:hover{background:var(--blue2)}
    .btn.secondary{background:#fff;color:var(--blue2);border:1px solid var(--g200);box-shadow:none}
    .container{max-width:1080px;margin:20px auto;padding:0 16px}
    .grid{display:grid;gap:14px}
    .card{background:#fff;border:1px solid var(--g200);border-radius:14px;box-shadow:var(--sh);padding:16px}
    section{display:none}
    section.active{display:block}
    .pill{padding:6px 10px;border-radius:999px;background:var(--b50);color:var(--blue2);font-weight:700;font-size:12px}
    .h1{font-size:24px;margin:0 0 6px}
    .h2{font-size:20px;margin:0 0 6px}
    .h3{font-size:16px;margin:0 0 6px}
    .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    input[type=text],input[type=password],input[type=number],textarea,select{padding:10px;border-radius:10px;border:1px solid var(--g200);background:var(--g50)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .list{display:flex;flex-direction:column;gap:10px}
    .position-card{border:1px dashed var(--g200);border-radius:12px;padding:12px;background:linear-gradient(180deg,#fff,#f8fbff)}
    .candidate-chip{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;background:#fff;border:1px solid var(--g200)}
    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--g200);margin-bottom:10px}
    .tab{padding:8px 12px;border-radius:10px 10px 0 0;background:var(--g100);cursor:pointer;font-weight:700}
    .tab.active{background:#fff;border:1px solid var(--g200);border-bottom-color:#fff}
    dialog{border:none;border-radius:12px;padding:16px;box-shadow:var(--sh);max-width:560px;width:92%}
    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);padding:10px 14px;border-radius:999px;background:#111827;color:#fff;box-shadow:var(--sh);z-index:99;display:none}
    .toast.show{display:block}
  </style>
  <link rel="icon" href="data:,">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: https: http:; connect-src * 'unsafe-inline' 'unsafe-eval'">
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand"><div class="logo"></div><div>전교임원선거</div></div>
      <div class="grow"></div>
      <button class="btn" data-action="open:settings">⚙️ 설정</button>
    </div>
  </header>

  <main class="container">
    <!-- 메인 -->
    <section id="view-home" class="active">
      <div class="card" style="padding:24px;background:linear-gradient(180deg,#ffffff,#f8fbff)">
        <div class="pill">연결 상태: <b id="pillConn">미설정</b></div>
        <h1 class="h1" style="font-size:28px;margin-top:8px">전교임원선거</h1>
        <p style="margin:6px 0 12px;color:var(--g600)">고유번호를 입력하고 투표를 시작하세요.</p>
        <div class="field" style="max-width:420px">
          <label style="font-weight:700">고유번호</label>
          <input id="inputVoterId" placeholder="예: S0001" />
        </div>
        <div class="row" style="margin-top:6px"><button class="btn" data-action="vote:start">투표 시작</button></div>
        <div class="row" style="margin-top:10px;gap:10px;font-size:12px;color:var(--g600)">
          <button class="btn secondary" style="padding:4px 8px;border-radius:8px;font-size:12px;box-shadow:none" data-action="nav:admin">관리자</button>
          <span>·</span>
          <button class="btn secondary" style="padding:4px 8px;border-radius:8px;font-size:12px;box-shadow:none" data-action="nav:results">개표</button>
          <span>·</span>
          <button class="btn secondary" style="padding:4px 8px;border-radius:8px;font-size:12px;box-shadow:none" data-action="open:settings">설정</button>
        </div>
      </div>
    </section>

    <!-- 관리자 -->
    <section id="view-admin">
      <div class="card" id="adminAuthCard">
        <h2 class="h2">관리자 로그인</h2>
        <div class="field"><label>비밀번호</label><input id="adminPwd" type="password" placeholder="admin" /></div>
        <div class="row"><button class="btn" data-action="admin:login">로그인</button></div>
      </div>
      <div class="card" id="adminMain" style="display:none">
        <div class="tabs"><div class="tab active" data-tab="design">설계</div><div class="tab" data-tab="voters">유권자</div><div class="tab" data-tab="system">시스템</div></div>
        <!-- 설계 탭 -->
        <div id="tab-design">
          <div class="row" style="justify-content:flex-end"><button class="btn secondary" data-action="pos:add">직위 추가</button><button class="btn" data-action="design:save">저장</button></div>
          <div class="list" id="positionsList"></div>
          <p style="color:var(--g600);font-size:12px">* 동일 직위 중복투표 불가. 각 직위는 1명만 선택하도록 렌더링됩니다.</p>
        </div>
        <!-- 유권자 탭 -->
        <div id="tab-voters" style="display:none">
          <div class="row"><div class="field"><label>생성 수</label><input id="genCount" type="number" value="30"></div><div class="field"><label>접두사</label><input id="genPrefix" type="text" value="S"></div><button class="btn" data-action="voters:gen">생성</button></div>
          <div class="row"><input id="csvFile" type="file" accept=".csv"><button class="btn secondary" data-action="voters:upload">CSV 업로드</button><button class="btn secondary" data-action="voters:preview">미리보기</button></div>
          <pre id="votersPreview" class="card" style="white-space:pre;max-height:240px;overflow:auto"></pre>
        </div>
        <!-- 시스템 탭 -->
        <div id="tab-system" style="display:none">
          <div class="field"><label>중앙 웹앱 URL</label><input id="sysWebUrl" type="text" placeholder="https://script.google.com/macros/s/.../exec"></div>
          <div class="field"><label>학교 코드</label><input id="sysTenant" type="text" placeholder="sch_jeju_elem"></div>
          <div class="row"><button class="btn" data-action="sys:save">저장</button><button class="btn secondary" data-action="sys:test">연결 테스트</button><button class="btn secondary" data-action="sys:init">테넌트 초기화</button><button class="btn secondary" data-action="sys:wipe">투표 초기화</button></div>
        </div>
      </div>
    </section>

    <!-- 투표 -->
    <section id="view-vote">
      <div class="card"><div class="row" style="justify-content:space-between"><div><h2 class="h2">투표</h2><p>고유번호: <b id="voteVoterId">-</b></p></div><button class="btn secondary" data-action="nav:home">메인으로</button></div><form id="voteForm" class="list"></form><div class="row" style="justify-content:flex-end"><button class="btn" data-action="vote:submit" disabled>제출</button></div></div>
    </section>

    <!-- 개표 -->
    <section id="view-results">
      <div class="card" id="resultsAuthCard"><h2 class="h2">개표(관리자)</h2><div class="field"><label>비밀번호</label><input id="resultsPwd" type="password" placeholder="admin"></div><div class="row"><button class="btn" data-action="results:login">접속</button></div></div>
      <div class="card" id="resultsMain" style="display:none"><div class="row" style="justify-content:space-between"><h2 class="h2">실시간 개표</h2><div class="row"><button class="btn secondary" data-action="results:refresh">새로고침</button><button class="btn" data-action="results:auto">자동갱신: 끔</button></div></div><div class="list" id="resultsWrap"></div></div>
    </section>
  </main>

  <!-- 설정 모달 -->
  <dialog id="dlgSettings">
    <form method="dialog">
      <h3 class="h3">설정</h3>
      <div class="field"><label>중앙 웹앱 URL</label><input id="cfgWebUrl" type="text" placeholder="https://script.google.com/macros/s/.../exec" /></div>
      <div class="field"><label>학교 코드</label><input id="cfgTenant" type="text" placeholder="sch_xxx" /></div>
      <div class="row"><button class="btn" data-action="cfg:save">저장</button><button class="btn secondary" data-action="cfg:close">닫기</button><button class="btn secondary" data-action="cfg:test">연결 테스트</button></div>
      <p style="color:var(--g600);font-size:12px">* 최초 사용 시 관리자 페이지 → 시스템 탭에서 <b>테넌트 초기화</b> 실행</p>
    </form>
  </dialog>

  <div id="toast" class="toast"></div>

  <script>
  (function(){
    const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const sections={home:'#view-home',admin:'#view-admin',vote:'#view-vote',results:'#view-results'};
    const AppState={ webAppUrl:localStorage.getItem('webAppUrl')||'', tenant:localStorage.getItem('tenant')||'', adminToken:null, resultsToken:null, voterId:null, autoTimer:null };
    const dlg=$('#dlgSettings');
    function toast(m){ const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1800); }
    function show(name){ Object.values(sections).forEach(sel=> $(sel)?.classList.remove('active')); $(sections[name])?.classList.add('active'); }
    function openDlg(){ try{ dlg.showModal(); }catch(e){ dlg.setAttribute('open',''); } }
    function closeDlg(){ try{ dlg.close(); }catch(e){ dlg.removeAttribute('open'); } }
    function pill(){ $('#pillConn').textContent=(AppState.webAppUrl && AppState.tenant)? `연결됨·${AppState.tenant}`:'미설정'; }

    // API (백엔드 연결; 설정 없으면 호출하지 말 것)
    const API={
      async call(path, method='GET', body=null, {auth=null}={}){
        if(!AppState.webAppUrl) throw new Error('웹앱 미설정'); if(!AppState.tenant) throw new Error('학교코드 미설정');
        const url=new URL(AppState.webAppUrl); url.searchParams.set('path', path); url.searchParams.set('tenant', AppState.tenant);
        const opt={method, headers:{'Content-Type':'application/json'}}; if(body) opt.body=JSON.stringify(body); if(auth) opt.headers['X-Auth']=auth;
        const res=await fetch(url.toString(),opt); if(!res.ok) throw new Error('요청 실패 '+res.status); return res.json();
      },
      init(){ return this.call('/init','POST',{}); },
      adminLogin(pwd){ return this.call('/auth/admin/login','POST',{password_plain:pwd}); },
      getDesign(){ return this.call('/design','GET'); },
      saveDesign(token,data){ return this.call('/design','POST',data,{auth:token}); },
      votersPreview(){ return this.call('/voters/preview','GET'); },
      votersGenerate(token,count,prefix){ return this.call('/voters/generate','POST',{count,prefix},{auth:token}); },
      votersUpload(token,rows){ return this.call('/voters/upload','POST',{rows},{auth:token}); },
      voteValidate(voter_id){ return this.call('/vote/validate','POST',{voter_id}); },
      voteSubmit(voter_id,selections,fingerprint){ return this.call('/vote/submit','POST',{voter_id,selections,fingerprint}); },
      getResults(token){ return this.call('/results','GET',null,{auth:token}); },
      wipeVotes(token){ return this.call('/admin/wipe','POST',{}, {auth:token}); },
      ensureSchema(token){ return this.call('/admin/initSchema','POST',{}, {auth:token}); },
    };

    // 설계 편집 UI
    const positionsList=()=> $('#positionsList');
    function newPosition(){ const id='P'+Math.random().toString(36).slice(2,6).toUpperCase(); return {position_id:id,title:'새 직위',order:0,enabled:true,_cands:[newCandidate(id)]}; }
    function newCandidate(position_id){ const id='C'+Math.random().toString(36).slice(2,6).toUpperCase(); return {position_id,candidate_id:id,name:'',class:'',description:'',photo_url:'',order:0,enabled:true}; }
    function createCandidateChip(c){ const chip=document.createElement('div'); chip.className='candidate-chip'; chip.dataset.cid=c.candidate_id; chip.innerHTML=`<input class="cand-name" type="text" placeholder="이름" value="${c.name||''}" /><input class="cand-class" type="text" placeholder="학급(선택)" value="${c.class||''}" /><input class="cand-photo" type="text" placeholder="사진 URL(선택)" value="${c.photo_url||''}" style="flex:1" /><button class="btn secondary" data-action="cand:del">삭제</button>`; return chip; }
    function createPositionCard(p){ const el=document.createElement('div'); el.className='position-card'; el.dataset.pid=p.position_id; el.innerHTML=`<div class="row" style="justify-content:space-between;align-items:center"><input class="pos-title" type="text" value="${p.title}" style="font-weight:700"/><div class="row"><label class="row" style="gap:6px;align-items:center"><input class="pos-enabled" type="checkbox" ${p.enabled?'checked':''}/> 활성</label><button class="btn secondary" data-action="cand:add">후보 추가</button><button class="btn secondary" data-action="pos:del">삭제</button></div></div><div class="list candidates" style="margin-top:8px"></div>`; const wrap=el.querySelector('.candidates'); p._cands.forEach(c=> wrap.appendChild(createCandidateChip(c))); return el; }

    async function loadDesign(){ const list=positionsList(); if(!list) return; list.innerHTML='<div>불러오는 중…</div>'; try{ const d=await API.getDesign(); list.innerHTML=''; const map={}; (d.positions||[]).sort((a,b)=>(a.order||0)-(b.order||0)).forEach(p=>{p._cands=[]; map[p.position_id]=p;}); (d.candidates||[]).forEach(c=> map[c.position_id]? map[c.position_id]._cands.push(c):null); Object.values(map).forEach(p=> list.appendChild(createPositionCard(p))); }catch(err){ console.error(err); list.innerHTML='<div>불러오기 실패</div>'; }
    }

    async function buildVoteForm(){ const wrap=$('#voteForm'); if(!wrap) return; wrap.innerHTML=''; try{ const d=await API.getDesign(); const byPos={}; (d.candidates||[]).forEach(c=> ((byPos[c.position_id] ||= []).push(c))); (d.positions||[]).sort((a,b)=>(a.order||0)-(b.order||0)).forEach(p=>{ const card=document.createElement('div'); card.className='position-card'; card.dataset.pid=p.position_id; card.innerHTML=`<div class="row" style="justify-content:space-between;align-items:center"><div class="h3">${p.title}</div><span class="pill">단일 선택</span></div>`; const list=document.createElement('div'); list.className='list'; (byPos[p.position_id]||[]).sort((a,b)=>(a.order||0)-(b.order||0)).forEach(c=>{ const row=document.createElement('label'); row.className='candidate-chip'; row.innerHTML=`<input type="radio" name="${p.position_id}" value="${c.candidate_id}" /><div style="display:flex;gap:10px;align-items:center"><div style="width:32px;height:32px;border-radius:999px;background:var(--g100);display:flex;align-items:center;justify-content:center">${(c.name||'').slice(0,1)}</div><div><div style="font-weight:700">${c.name||''}</div><div style="font-size:12px;color:var(--g600)">${c.class||''}</div></div></div>`; list.appendChild(row); }); card.appendChild(list); wrap.appendChild(card); }); $('[data-action="vote:submit"]').disabled=false; }catch(err){ console.error(err); wrap.innerHTML='<div>설계 로드 실패</div>'; }}

    async function previewVoters(){ try{ const r=await API.votersPreview(); const lines=['voter_id,class,name,used,last_vote_ts']; (r.voters||[]).forEach(v=> lines.push([v.voter_id,v.class||'',v.name||'',v.used?'TRUE':'FALSE',v.last_vote_ts||''].join(','))); $('#votersPreview').textContent=lines.join('\n'); }catch(err){ console.error(err); toast('미리보기 실패'); }}

    async function renderResults(){ try{ const r=await API.getResults(AppState.resultsToken); const wrap=$('#resultsWrap'); wrap.innerHTML=''; (r.results||[]).forEach(pos=>{ const total=(pos.items||[]).reduce((a,b)=> a+(b.votes||0),0)||1; const card=document.createElement('div'); card.className='card'; card.innerHTML=`<div class="h3">${pos.title}</div>`; (pos.items||[]).forEach(it=>{ const rate=((it.votes||0)/total*100); const row=document.createElement('div'); row.innerHTML=`<div class="row" style="justify-content:space-between;align-items:center"><div>${it.name}</div><div class="row" style="gap:8px"><b>${it.votes}</b><span style="color:var(--g600)">(${rate.toFixed(1)}%)</span></div></div><div style="height:8px;background:var(--g100);border-radius:999px;overflow:hidden"><i style="display:block;height:100%;background:var(--blue);width:${rate}%"></i></div>`; card.appendChild(row); }); wrap.appendChild(card); }); }catch(err){ console.error(err); toast('결과 로드 실패'); }
    }

    // 전역 이벤트 위임 (클릭)
    document.addEventListener('click', async (ev)=>{
      const btn = ev.target.closest('[data-action]');
      if(!btn) return;
      // 모든 버튼은 기본적으로 submit 방지
      if(btn.tagName==='BUTTON' && !btn.getAttribute('type')) btn.setAttribute('type','button');
      const act = btn.getAttribute('data-action');
      try{
        // 네비게이션
        if(act==='nav:home') return show('home');
        if(act==='nav:admin') return show('admin');
        if(act==='nav:vote') return show('vote');
        if(act==='nav:results') return show('results');

        // 설정 모달
        if(act==='open:settings'){ $('#cfgWebUrl').value=AppState.webAppUrl||''; $('#cfgTenant').value=AppState.tenant||''; return openDlg(); }
        if(act==='cfg:close') return (ev.preventDefault(), closeDlg());
        if(act==='cfg:save'){
          ev.preventDefault(); const w=$('#cfgWebUrl').value.trim(); const t=$('#cfgTenant').value.trim(); if(!w||!t) return toast('웹앱URL/학교코드 입력');
          AppState.webAppUrl=w; AppState.tenant=t; localStorage.setItem('webAppUrl',w); localStorage.setItem('tenant',t); pill(); closeDlg(); return toast('저장됨');
        }
        if(act==='cfg:test'){
          ev.preventDefault(); const w=$('#cfgWebUrl').value.trim(); const t=$('#cfgTenant').value.trim(); if(!w||!t) return toast('웹앱URL/학교코드 입력');
          AppState.webAppUrl=w; AppState.tenant=t; pill(); try{ await API.init(); toast('연결 성공'); }catch(err){ console.error(err); toast('연결 실패'); } return;
        }

        // 메인 투표 시작
        if(act==='vote:start'){
          const id=$('#inputVoterId').value.trim(); if(!id) return toast('고유번호 입력');
          try{ const r=await API.voteValidate(id); if(!r.allowed) throw new Error('not-allowed'); AppState.voterId=id; $('#voteVoterId').textContent=id; await buildVoteForm(); return show('vote'); }
          catch(err){ console.error(err); return toast('유효하지 않거나 이미 투표됨'); }
        }
        if(act==='vote:submit'){
          const selections=[]; $$('#voteForm .position-card').forEach(card=>{ const name=card.dataset.pid; const sel=card.querySelector(`input[name="${name}"]:checked`); if(sel) selections.push({position_id:name,candidate_id:sel.value}); });
          if(!selections.length) return toast('선택 후 제출');
          try{ await API.voteSubmit(AppState.voterId, selections, navigator.userAgent.slice(0,120)); toast('투표 완료!'); AppState.voterId=null; return show('home'); }
          catch(err){ console.error(err); return toast('제출 실패'); }
        }

        // 관리자 로그인/탭
        if(act==='admin:login'){
          const pwd=$('#adminPwd').value; if(!pwd) return toast('비밀번호 입력');
          try{ const r=await API.adminLogin(pwd); AppState.adminToken=r.token; $('#adminAuthCard').style.display='none'; $('#adminMain').style.display='block'; await loadDesign(); }
          catch(err){ console.error(err); toast('인증 실패'); }
          return;
        }
        if(act==='pos:add'){
          positionsList()?.prepend(createPositionCard(newPosition()));
          return;
        }
        if(act==='design:save'){
          const positions=[], candidates=[]; $$('#positionsList .position-card').forEach((pc,idx)=>{
            const pid=pc.dataset.pid; const title=pc.querySelector('.pos-title').value.trim(); const enabled=pc.querySelector('.pos-enabled').checked; positions.push({position_id:pid,title,enabled,order:idx+1});
            pc.querySelectorAll('.candidate-chip').forEach((cc,cidx)=>{ candidates.push({position_id:pid,candidate_id:cc.dataset.cid,name:cc.querySelector('.cand-name').value.trim(),class:cc.querySelector('.cand-class').value.trim(),photo_url:cc.querySelector('.cand-photo').value.trim(),enabled:true,order:cidx+1}); });
          });
          try{ await API.saveDesign(AppState.adminToken,{positions,candidates}); toast('저장 완료'); }catch(err){ console.error(err); toast('저장 실패'); }
          return;
        }
        if(act==='cand:add'){
          const card=btn.closest('.position-card'); const pid=card?.dataset.pid; if(!pid) return; const wrap=card.querySelector('.candidates'); wrap.appendChild(createCandidateChip(newCandidate(pid))); return;
        }
        if(act==='pos:del') { btn.closest('.position-card')?.remove(); return; }
        if(act==='cand:del'){ btn.closest('.candidate-chip')?.remove(); return; }

        // 유권자
        if(act==='voters:gen'){
          const count=parseInt($('#genCount').value||'0',10); const prefix=$('#genPrefix').value||'S'; if(!count) return toast('생성 수 입력'); try{ await API.votersGenerate(AppState.adminToken,count,prefix); toast('생성 완료'); await previewVoters(); }catch(err){ console.error(err); toast('생성 실패'); } return;
        }
        if(act==='voters:preview') return previewVoters();
        if(act==='voters:upload'){
          const f=$('#csvFile').files[0]; if(!f) return toast('CSV 선택'); const txt=await f.text(); const rows=txt.split(/\r?\n/).slice(1).map(l=> l.split(',')).filter(a=> a.length>=2).map(a=> ({class:a[0]?.trim(), name:a[1]?.trim()})); try{ await API.votersUpload(AppState.adminToken, rows); toast('업로드 완료'); await previewVoters(); }catch(err){ console.error(err); toast('업로드 실패'); } return;
        }

        // 시스템
        if(act==='sys:save'){ const w=$('#sysWebUrl').value.trim(); const t=$('#sysTenant').value.trim(); if(!w||!t) return toast('웹앱URL/학교코드 입력'); AppState.webAppUrl=w; AppState.tenant=t; localStorage.setItem('webAppUrl',w); localStorage.setItem('tenant',t); pill(); return toast('저장됨'); }
        if(act==='sys:test'){ try{ await API.init(); toast('연결 성공'); }catch(err){ console.error(err); toast('연결 실패'); } return; }
        if(act==='sys:init'){ try{ await API.ensureSchema(AppState.adminToken); toast('테넌트 초기화 완료'); }catch(err){ console.error(err); toast('실패'); } return; }
        if(act==='sys:wipe'){ if(!confirm('투표 데이터를 초기화할까요?')) return; try{ await API.wipeVotes(AppState.adminToken); toast('초기화 완료'); }catch(err){ console.error(err); toast('실패'); } return; }

        // 개표
        if(act==='results:login'){ const pwd=$('#resultsPwd').value; if(!pwd) return toast('비밀번호 입력'); try{ const r=await API.adminLogin(pwd); AppState.resultsToken=r.token; $('#resultsAuthCard').style.display='none'; $('#resultsMain').style.display='block'; await renderResults(); }catch(err){ console.error(err); toast('인증 실패'); } return; }
        if(act==='results:refresh') return renderResults();
        if(act==='results:auto'){ if(AppState.autoTimer){ clearInterval(AppState.autoTimer); AppState.autoTimer=null; btn.textContent='자동갱신: 끔'; } else { AppState.autoTimer=setInterval(renderResults,2500); btn.textContent='자동갱신: 켬'; } return; }

      }catch(err){ console.error('[handler]', err); toast('동작 중 오류'); }
    });

    window.addEventListener('DOMContentLoaded', ()=>{ // 기본 표시 & 버튼 type 보정
      document.querySelectorAll('button').forEach(b=>{ if(!b.getAttribute('type')) b.setAttribute('type','button'); });
      show('home'); pill();
    });

    window.addEventListener('error', (e)=>{ try{ const t=document.getElementById('toast'); if(t){ t.textContent='스크립트 오류: '+(e?.message||''); t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2500);} }catch(_){} console.error('[GLOBAL ERROR]', e); });
  })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <title>신남 좌석 매매·임대장 · Pastel v7</title>
    <meta name="theme-color" content="#ffffff" />
    <style>
      :root{
        --bg:#ffffff;--text:#1f2937;--muted:#6b7280;--border:#e5e7eb;--card:#f8fafc;--brand:#6366f1;
        --vacant:#ffe4e6;--vacant-b:#fecdd3;--rent:#e0f2fe;--rent-b:#bae6fd;--board:#ecfdf5;--board-b:#a7f3d0;
      }
      html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}
      *{box-sizing:border-box}
      .container{max-width:1100px;margin:0 auto;padding:20px 14px 80px}
      .hstack{display:flex;align-items:center;gap:8px}
      .between{display:flex;align-items:center;justify-content:space-between;gap:8px}
      .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#f9fafb;cursor:pointer}
      .btn:hover{background:#f3f4f6}
      .btn-ghost{padding:6px 10px;border-radius:10px;border:1px dashed var(--border);background:transparent;cursor:pointer}
      .input{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#fff;color:#111827;width:100%}
      .select{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#fff;color:#111827}
      .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}
      .badge{font-size:12px;padding:2px 6px;border-radius:999px;border:1px solid var(--border);background:#fff;color:#374151}
      .title-sm{font-size:13px;color:var(--muted);margin-bottom:6px;font-weight:600}
      .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
      .grid24{display:grid;grid-template-rows:repeat(4,auto);gap:8px}
      .row2{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
      .board{margin-top:12px;padding:6px 10px;font-size:13px;text-align:center;border-radius:12px;background:var(--board);color:#047857;border:1px solid var(--board-b)}
      .summary{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:14px;text-align:center}
      .summary .card{font-size:13px}
      .seat{position:relative;padding:10px;border-radius:12px;text-align:left;border:1px solid var(--border);background:#fff;cursor:pointer;display:flex;flex-direction:column;gap:4px;transition:transform .06s ease, box-shadow .12s ease, opacity .12s}
      .seat:hover{transform:translateY(-1px);box-shadow:0 4px 14px rgba(0,0,0,.06)}
      .seat .top{display:flex;justify-content:space-between;align-items:center}
      .label{font-size:13px;font-weight:800;color:#374151}
      .line{font-size:12px;color:#374151;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
      .price{font-size:12px;font-weight:700;color:#111827}
      .price .muted{color:var(--muted);font-weight:400}
      .pill{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#fff}
      .seg{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}
      .seg button{padding:6px 10px;border:0;background:#fff;cursor:pointer}
      .seg button.active{background:#eef2ff;color:#4338ca}
      .ring{outline:2px solid #a5b4fc}
      .muted-opa{opacity:.35}
      /* modal */
      .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:50}
      .modal{background:#fff;border:1px solid var(--border);border-radius:14px;padding:16px;width:480px;max-width:92vw}
      .field{display:flex;flex-direction:column;gap:4px}
      .cols{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
      .tiny{font-size:12px;color:var(--muted)}
      .w-clip{width:min(160px,42vw)}
      @media (max-width:900px){.grid3{grid-template-columns:1fr}} 
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const {useState,useMemo,useEffect} = React;

      // storage helpers
      const isClient = typeof window!=="undefined";
      const safeGet=(k,f=null)=>{if(!isClient)return f;try{return localStorage.getItem(k)??f;}catch{return f;}};
      const safeSet=(k,v)=>{if(!isClient)return;try{localStorage.setItem(k,v);}catch{}};

      // keys (v7)
      const STORAGE_KEY="seat-market-v7";
      const PIN_KEY="seat-market-pin";const LOCK_KEY="seat-market-locked";const BOARD_KEY="seat-market-board-top";
      const DENSITY_KEY="seat-market-density";const WRAP_KEY="seat-market-wrap";const SHOW_PRICE_BADGE_KEY="seat-market-price-badge";

      // utils
      const KRW=(n)=>(Number(n)||0).toLocaleString("ko-KR",{maximumFractionDigits:0})+"원";
      const now=()=>new Date().toISOString();
      const labels=()=>{const a=[];for(let b=1;b<=3;b++){for(let r=0;r<4;r++){const ch=String.fromCharCode(65+r);for(let c=1;c<=2;c++)a.push(`${b}${ch}${c}`)}}return a};

      const defSeats=()=>labels().map((label,i)=>({id:i+1,label,block:Number(label[0]),row:label[1],col:Number(label[2]),owner:"",tenant:"",price:0,rentFee:0,lastUpdated:now(),history:[]}));

      const loadState=()=>{try{const raw=safeGet(STORAGE_KEY);if(!raw)return defSeats();const p=JSON.parse(raw);if(!Array.isArray(p)||p.length!==24)return defSeats();return p;}catch{return defSeats();}};
      const saveState=(seats)=>safeSet(STORAGE_KEY,JSON.stringify(seats));

      const loadPin=()=>safeGet(PIN_KEY,"");const savePin=(v)=>safeSet(PIN_KEY,v||"");
      const loadLocked=()=>safeGet(LOCK_KEY,"true")==="true";const saveLocked=(v)=>safeSet(LOCK_KEY,String(!!v));
      const loadBoard=()=>safeGet(BOARD_KEY,"true")==="true";const saveBoard=(v)=>safeSet(BOARD_KEY,String(!!v));
      const loadDensity=()=>safeGet(DENSITY_KEY,"medium");const saveDensity=(v)=>safeSet(DENSITY_KEY,v);
      const loadWrap=()=>safeGet(WRAP_KEY,"false")==="true";const saveWrap=(v)=>safeSet(WRAP_KEY,String(!!v));
      const loadPriceBadge=()=>safeGet(SHOW_PRICE_BADGE_KEY,"true")==="true";const savePriceBadge=(v)=>safeSet(SHOW_PRICE_BADGE_KEY,String(!!v));

      function App(){
        const [seats,setSeats]=useState(loadState);
        const [q,setQ]=useState("");
        const [sort,setSort]=useState("label");
        const [pin,setPin]=useState(loadPin);
        const [locked,setLocked]=useState(loadLocked);
        const [boardTop,setBoardTop]=useState(loadBoard);
        const [density,setDensity]=useState(loadDensity);
        const [wrap,setWrap]=useState(loadWrap);
        const [showPriceBadge,setShowPriceBadge]=useState(loadPriceBadge);
        const [exportOpen,setExportOpen]=useState(false);
        const [importOpen,setImportOpen]=useState(false);
        const [editOpen,setEditOpen]=useState(false);
        const [activeId,setActiveId]=useState(null);
        const [undoStack,setUndoStack]=useState([]);

        useEffect(()=>saveState(seats),[seats]);
        useEffect(()=>savePin(pin),[pin]);
        useEffect(()=>saveLocked(locked),[locked]);
        useEffect(()=>saveBoard(boardTop),[boardTop]);
        useEffect(()=>saveDensity(density),[density]);
        useEffect(()=>saveWrap(wrap),[wrap]);
        useEffect(()=>savePriceBadge(showPriceBadge),[showPriceBadge]);

        // derived
        const qText=q.trim().toLowerCase();
        const matchSeat=(s)=>!qText||s.label.toLowerCase().includes(qText)||s.owner.toLowerCase().includes(qText)||s.tenant.toLowerCase().includes(qText);
        const sorted=useMemo(()=>{
          const list=[...seats];
          if(sort==="priceDesc") list.sort((a,b)=>b.price-a.price);
          else if(sort==="priceAsc") list.sort((a,b)=>a.price-b.price);
          else if(sort==="vacant") list.sort((a,b)=>(a.tenant?1:0)-(b.tenant?1:0));
          else list.sort((a,b)=>a.label.localeCompare(b.label,"ko"));
          return list;
        },[seats,sort]);

        const stats=useMemo(()=>{
          const total=seats.reduce((acc,s)=>acc+(Number(s.price)||0),0);
          const avg=total/seats.length;const max=seats.slice().sort((a,b)=>b.price-a.price)[0];
          return {total,avg,max};
        },[seats]);

        // undo & guard
        const pushUndo=(prev)=>setUndoStack(st=>[JSON.stringify(prev),...st].slice(0,15));
        const undo=()=>{if(!undoStack.length)return alert("되돌릴 기록이 없음");const [top,...rest]=undoStack;setSeats(JSON.parse(top));setUndoStack(rest)};
        const requireEdit=(fn)=>{if(!pin)return fn();if(!locked)return fn();const input=prompt("편집 PIN 입력");if(input===pin)fn();else alert("PIN 불일치")};

        const updateSeat=(id,patch,note)=>{
          setSeats(prev=>{const snap=prev.map(s=>({...s}));pushUndo(snap);return prev.map(s=>s.id===id?{...s,...patch,lastUpdated:now(),history:note?[{time:now(),note},...(s.history||[])].slice(0,20):s.history}:s)});
        };

        const resetAll=()=>{if(!confirm("전체 초기화함? (되돌리기 가능)"))return;pushUndo(seats);setSeats(defSeats())};

        const active=seats.find(s=>s.id===activeId)||null;

        // density → min height
        const seatMinH = density==="small" ? (wrap?78:64) : density==="large" ? (wrap?122:96) : (wrap?100:80);
        const seatStyle=(vacant)=>({background:vacant?"var(--vacant)":"var(--rent)",borderColor:vacant?"var(--vacant-b)":"var(--rent-b)",minHeight:seatMinH});

        return (
          <div className="container">
            {/* header */}
            <div className="between">
              <div className="hstack">
                <div style={{width:38,height:38,borderRadius:12,background:"#f3f4f6",border:"1px solid var(--border)",display:"flex",alignItems:"center",justifyContent:"center"}}>🎒</div>
                <div>
                  <div style={{fontWeight:800}}>신남 좌석 매매·임대장</div>
                  <div className="tiny">3분단(2×4) = 24석 · 로컬 저장</div>
                </div>
              </div>
              <div className="hstack">
                <button className="btn" onClick={undo}>⏪ 되돌리기</button>
                <details>
                  <summary className="btn">⚙️ 설정</summary>
                  <div className="card" style={{marginTop:6,minWidth:300}}>
                    <div className="title-sm">보안/데이터</div>
                    <div className="between"><span>편집 잠금</span><input type="checkbox" checked={locked} onChange={e=>setLocked(e.target.checked)} /></div>
                    <div className="between" style={{marginTop:6}}><span>PIN</span><input className="input" style={{width:120}} value={pin} onChange={e=>setPin(e.target.value)} placeholder="숫자 4자리" /></div>
                    <hr style={{border:0,borderTop:"1px solid var(--border)",margin:"10px 0"}}/>
                    <div className="title-sm">배치/표시</div>
                    <button className="btn" onClick={()=>setBoardTop(v=>!v)}>칠판 위치 전환 (현재 {boardTop?"상단":"하단"})</button>
                    <div className="between" style={{marginTop:8}}>
                      <span>칸 크기</span>
                      <div className="seg">
                        {(["small","medium","large"]).map(d=>(
                          <button key={d} className={density===d?"active":""} onClick={()=>setDensity(d)}>{d==="small"?"작게":d==="medium"?"보통":"크게"}</button>
                        ))}
                      </div>
                    </div>
                    <div className="between" style={{marginTop:8}}><span>텍스트 줄바꿈</span><input type="checkbox" checked={wrap} onChange={e=>setWrap(e.target.checked)} /></div>
                    <div className="between" style={{marginTop:8}}><span>가격 배지 표시</span><input type="checkbox" checked={showPriceBadge} onChange={e=>setShowPriceBadge(e.target.checked)} /></div>
                    <hr style={{border:0,borderTop:"1px solid var(--border)",margin:"10px 0"}}/>
                    <div className="hstack">
                      <button className="btn" onClick={()=>setExportOpen(true)}>데이터 내보내기</button>
                      <button className="btn" onClick={()=>setImportOpen(true)}>데이터 가져오기</button>
                      <button className="btn" onClick={resetAll}>전체 초기화</button>
                    </div>
                  </div>
                </details>
              </div>
            </div>

            {/* search/sort */}
            <div className="hstack" style={{marginTop:10}}>
              <input className="input" style={{flex:1}} placeholder="좌석 라벨(예: 2B1), 소유주, 임차인 검색" value={q} onChange={e=>setQ(e.target.value)} />
              <select className="select" value={sort} onChange={e=>setSort(e.target.value)}>
                <option value="label">라벨순</option>
                <option value="priceDesc">가격 높은순</option>
                <option value="priceAsc">가격 낮은순</option>
                <option value="vacant">빈자리 우선</option>
              </select>
            </div>

            {boardTop && <div className="board">🧑‍🏫 칠판 (교탁) — 이쪽이 앞</div>}

            {/* seat grid */}
            <div className="grid3">
              {[1,2,3].map(block=> (
                <div key={block} className="card">
                  <div className="title-sm">{block}분단</div>
                  <div className="grid24">
                    {Array.from({length:4}).map((_,r)=> (
                      <div key={r} className="row2">
                        {Array.from({length:2}).map((_,c)=>{
                          const row=String.fromCharCode(65+r);const col=c+1;const label=`${block}${row}${col}`;
                          const seat=seats.find(s=>s.label===label);
                          const vacant=!seat?.tenant;const match=matchSeat(seat);
                          return (
                            <button key={label} className={`seat ${match?"ring":""} ${qText&&!match?"muted-opa":""}`} style={{...seatStyle(vacant)}} onClick={()=>{setActiveId(seat.id);setEditOpen(true);}}>
                              <div className="top">
                                <div className="label">{label}</div>
                                <span className="badge" style={{display:showPriceBadge?"inline-flex":"none"}}>{KRW(seat.price)}</span>
                              </div>
                              <div className="line" style={{whiteSpace:wrap?"normal":"nowrap"}}>소유주: {seat.owner || "-"}</div>
                              <div className="line" style={{whiteSpace:wrap?"normal":"nowrap"}}>임차인: {seat.tenant || "-"}</div>
                              <div className="price">{vacant?"":<span className="tiny">임대료 <span className="muted">{KRW(seat.rentFee)}</span></span>}</div>
                            </button>
                          );
                        })}
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>

            {!boardTop && <div className="board">🧑‍🏫 칠판 (교탁) — 이쪽이 앞</div>}

            {/* summary */}
            <div className="summary">
              <div className="card"><div className="tiny">총 시가</div><div style={{fontWeight:800}}>{KRW(stats.total)}</div></div>
              <div className="card"><div className="tiny">평균가</div><div style={{fontWeight:800}}>{KRW(stats.avg)}</div></div>
              <div className="card"><div className="tiny">최고가</div><div style={{fontWeight:800}}>{stats.max?`${stats.max.label} · ${KRW(stats.max.price)}`:"-"}</div></div>
            </div>

            {/* edit modal */}
            {editOpen && active && (
              <div className="backdrop" onClick={()=>setEditOpen(false)}>
                <div className="modal" onClick={(e)=>e.stopPropagation()}>
                  <div style={{fontWeight:800,marginBottom:8}}>좌석 정보 수정</div>
                  <div className="tiny" style={{marginBottom:8}}>라벨: <b style={{color:"#111827"}}>{active.label}</b></div>
                  <div className="cols">
                    <div className="field">
                      <div className="tiny">소유주</div>
                      <input className="input w-clip" value={active.owner} onChange={e=>requireEdit(()=>updateSeat(active.id,{owner:e.target.value},`소유주 → ${e.target.value}`))} />
                    </div>
                    <div className="field">
                      <div className="tiny">임차인</div>
                      <input className="input w-clip" value={active.tenant} onChange={e=>requireEdit(()=>updateSeat(active.id,{tenant:e.target.value},`임차인 → ${e.target.value}`))} />
                    </div>
                  </div>
                  <div className="cols" style={{marginTop:8}}>
                    <div className="field">
                      <div className="tiny">가격</div>
                      <input type="number" className="input w-clip" value={active.price} onChange={e=>requireEdit(()=>updateSeat(active.id,{price:Number(e.target.value||0)},`가격 → ${e.target.value}`))} />
                    </div>
                    <div className="field">
                      <div className="tiny">임대료</div>
                      <input type="number" className="input w-clip" value={active.rentFee} onChange={e=>requireEdit(()=>updateSeat(active.id,{rentFee:Number(e.target.value||0)},`임대료 → ${e.target.value}`))} />
                    </div>
                  </div>
                  <div className="hstack" style={{justifyContent:"flex-end",marginTop:12}}>
                    <button className="btn-ghost" onClick={()=>requireEdit(()=>updateSeat(active.id,{owner:"",tenant:"",price:0,rentFee:0},"좌석 초기화"))}>초기화</button>
                    <button className="btn" onClick={()=>setEditOpen(false)}>닫기</button>
                  </div>
                </div>
              </div>
            )}

            {/* export */}
            {exportOpen && (
              <div className="backdrop" onClick={()=>setExportOpen(false)}>
                <div className="modal" onClick={(e)=>e.stopPropagation()}>
                  <div style={{fontWeight:800,marginBottom:8}}>데이터 내보내기 (JSON)</div>
                  <textarea readonly className="input" style={{height:220}} value={JSON.stringify(seats,null,2)}></textarea>
                  <div className="hstack" style={{justifyContent:"flex-end",marginTop:12}}>
                    <button className="btn" onClick={()=>{navigator.clipboard.writeText(JSON.stringify(seats));alert("복사됨")}}>복사</button>
                    <button className="btn" onClick={()=>setExportOpen(false)}>닫기</button>
                  </div>
                </div>
              </div>
            )}

            {/* import */}
            {importOpen && (
              <ImportModal onClose={()=>setImportOpen(false)} onLoad={(data)=>{ if(!Array.isArray(data)||data.length!==24) return alert("형식 오류: 배열 24개 필요"); requireEdit(()=>setSeats(data)); setImportOpen(false); }} />
            )}
          </div>
        );
      }

      function ImportModal({onClose,onLoad}){
        const [raw,setRaw]=useState("");
        return (
          <div className="backdrop" onClick={onClose}>
            <div className="modal" onClick={(e)=>e.stopPropagation()}>
              <div style={{fontWeight:800,marginBottom:8}}>데이터 가져오기 (JSON 붙여넣기)</div>
              <textarea className="input" style={{height:220}} placeholder="여기에 JSON 붙여넣기" value={raw} onChange={e=>setRaw(e.target.value)} />
              <div className="hstack" style={{justifyContent:"flex-end",marginTop:12}}>
                <button className="btn" onClick={()=>{try{const data=JSON.parse(raw);onLoad(data);}catch{alert("JSON 파싱 오류")}}}>불러오기</button>
                <button className="btn" onClick={onClose}>닫기</button>
              </div>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
    </script>
  </body>
</html>
